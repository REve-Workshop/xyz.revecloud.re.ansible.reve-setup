# The host user must be root.
---
- hosts: all
  gather_facts: False
  tasks:
    - name: Setup Time Zone
      timezone:
        name: 'Europe/Brussels'
    - name: Setup third party Git repository directory
      file:
        path: "{{ git_3rdparty }}"
        state: directory
    - name: Enable package manager's extra repositories
      include_role:
        name: enable-pm-repos
    - name: Ensure System is up to date
      dnf:
        name: "*"
        state: latest
    - name: Install applications from package manager
      include_role:
        name: common
        tasks_from: manage-pkg
      loop: "{{ applications|dict2items }}"
      loop_control:
        loop_var: applic
    - name: Install antigen (ZSH package manager)
      git:
        repo: "{{ applications.zsh.antigen.repo }}"
        dest: "{{ git_3rdparty }}/{{ applications.zsh.antigen.dir }}"
        version: 'HEAD'
    - name: Install Common Lisp dependencies
      block:
        - name: Ensure a directory exist for the quicklisp sources
          file:
            path: "{{ git_3rdparty }}/{{ applications.common_lisp.ql_repo_dir }}"
            state: directory
        - name: Download Quicklisp
          get_url:
            url: https://beta.quicklisp.org/quicklisp.lisp
            dest: "{{ git_3rdparty }}/{{ applications.common_lisp.ql_repo_dir }}"
    - name: Create the user for building applcations from source
      block:
        - name: Load user description data
          include_vars:
            file: "{{ users_dir }}/builder.yml"
            name: user_data
        - name: Create the user
          include_role:
            name: config-xdg
        - name: Update configuration repositories and deploy XDG compliant configuration elements
          include_role:
            name: common
            tasks_from: manage-cfg.yml
          loop: "{{ user_data.configurations|dict2items }}"
          loop_control:
            loop_var: user_conf
        - name: Deploy configuration elements
          include_role:
            name: user-configuration
    - name: Install StumpWM
      include_role:
        name: stumpwm
